# codefresh.yml example with deploy to ecs step
version: '1.0'

steps:
  build-step:
    type: build
    title: Building
    description: Building the sonarqube image...
    image_name: ppavlov/sonarqube
    tag: ${{CF_BRANCH_TAG_NORMALIZED}}

  perform_tests:
    image: ${{build_step}}
    description: Performing unit tests...
    commands:
      - docker run -d -p 9000:9000 -p 9092:9092 ppavlov/sonarqube:tag; sleep 10
      - curl --retry 10 --retry-delay 5 -v http://localhost:9000/

  push_to_registry:
    type: push
    candidate: ${{build-step}}
    tag: ${{CF_BRANCH_TAG_NORMALIZED}}

  deploy_to_ecs:
    image: codefresh/cf-deploy-ecs
    commands:
      - cfecs-update eu-west-1 <ecs-cluster-name> <ecs-service-name>
    environment:
      - AWS_ACCESS_KEY_ID=${{AWS_ACCESS_KEY_ID}}
      - AWS_SECRET_ACCESS_KEY=${{AWS_SECRET_ACCESS_KEY}}

    when:
      branch:
        only:
          - master
